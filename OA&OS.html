<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Open Access & Open Science</title>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
  body{margin:0;font-family:Segoe UI,Arial;background:#f4f6fa;}
  header{
    background:#0b63b6;color:white;
    padding:15px;text-align:center;
    font-size:22px;font-weight:600;
  }
  #canvas{height:calc(100vh - 60px);position:relative;}
  svg{width:100%;height:100%;cursor:grab;}

  .node text{font-size:14px;pointer-events:none;}
  .node rect{
    rx:10;ry:10;stroke-width:2;
    filter:drop-shadow(0 1px 2px rgba(0,0,0,0.15));
  }

  .link{fill:none;stroke:#bfbfbf;stroke-width:2;}

  .end-dot{
    fill:#d32f2f;stroke:#b00000;stroke-width:1.5;
  }

  .tooltip{
    position:absolute;display:none;
    background:rgba(0,0,0,0.85);color:white;
    padding:8px 12px;border-radius:6px;
    max-width:300px;font-size:13px;
    z-index:100;
  }

  #legend{
    position:absolute;left:15px;top:15px;
    background:white;padding:10px;border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
    font-size:13px;z-index:20;
  }

  #fitBtn{
    position:absolute;right:15px;top:15px;
    background:white;border:1px solid #cbd3dd;
    padding:8px 12px;border-radius:6px;
    cursor:pointer;font-size:13px;
    box-shadow:0 1px 4px rgba(0,0,0,0.15);
    z-index:20;
  }
</style>
</head>

<body>
<header>Open Access & Open Science</header>

<div id="canvas">
  <div id="legend">
    NEHU DLISc Workshop<br>
    Presented on 22.11.2025<br>
    Author: <br> Dr. Tamal Kumar Guha </br>
  </div>

  <!-- <button id="fitBtn">Fit to View</button> -->

  <div id="tooltip" class="tooltip"></div>
  <svg></svg>
</div>


<script>
// ----------------------------------
// CONFIG
// ----------------------------------
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQtE2jkMXdOlWaUrLFglbi5PH7hwvN0H7wV-A3EEZrQjZFLhI_d0AA1_nN-I9YrXXlmwzgolneWo8Uk/pub?gid=0&single=true&output=csv";

const ROOT_ID = "1";
const LEFT_COUNT = 2;

// compact layout
const VERT_SPACING = 60;
const DEPTH_SPACING = 200;

// colors
const fills  = ["#08306b","#e3f2fd","#fff3e0","#e8f5e9","#f3e8ff","#fff5f5"];
const strokes=["#08306b","#2b6cb0","#fb8c00","#2e7d32","#6a1b9a","#c62828"];


// ----------------------------------
// SVG + ZOOM
// ----------------------------------
const svg = d3.select("svg");
const g = svg.append("g");
const tooltip = d3.select("#tooltip");

const zoom = d3.zoom()
  .scaleExtent([0.2,3])
  .on("zoom", e => g.attr("transform", e.transform));

svg.call(zoom);

document.getElementById("fitBtn").onclick = () => fitToContent();


// ----------------------------------
// LOAD CSV
// ----------------------------------
d3.csv(CSV_URL).then(raw => {

  // normalize rows
  raw = raw.map(r => ({
    ID: String(r.ID || "").trim(),
    Name: (r.Name || r.NAMES || "").trim(),
    ParentID: String(r.ParentID || "").trim(),
    PhotoURL: (r.PhotoURL || "").trim(),
    Details: (r.Details || "").trim()
  }));

  // build map
  const map = new Map();
  raw.forEach(r => {
    if(r.ID) map.set(r.ID, {...r, children:[]});
  });

  // attach children
  map.forEach(node => {
    if(node.ParentID && map.has(node.ParentID)){
      map.get(node.ParentID).children.push(node);
    }
  });

  // root
  if(!map.has(ROOT_ID)){
    alert("Root ID not found.");
    return;
  }

  const rootNode = map.get(ROOT_ID);

  // attach orphan top-level nodes under root
  raw.forEach(r => {
    if(!r.ParentID && r.ID !== ROOT_ID){
      rootNode.children.push(map.get(r.ID));
    }
  });

  const root = d3.hierarchy(rootNode, d => d.children.length ? d.children : null);
  root.x0 = 0;
  root.y0 = 0;

  // assign left/right
  if(root.children){
    root.children.forEach((c,i)=>{
      const side = (i < LEFT_COUNT ? -1 : 1);
      assignSide(c, side);
    });
  }

  // collapse all
  root.children?.forEach(collapseAll);

  // expand first level
  root.children?.forEach(c => { c.children = c._children; c._children = null; });

  update(root);

  // auto-fit once on load
  setTimeout(() => fitToContent(), 500);


  // ----------------------------------
  // FUNCTIONS
  // ----------------------------------

  function assignSide(node, side){
    node.data._side = side;
    node.children?.forEach(c => assignSide(c, side));
    node._children?.forEach(c => assignSide(c, side));
  }

  function collapseAll(node){
    if(node.children){
      node._children = node.children;
      node._children.forEach(collapseAll);
      node.children = null;
    }
  }


  // UPDATE FUNCTION
  function update(source){

    const layout = d3.tree().nodeSize([VERT_SPACING,100]);
    const treeData = layout(root);
    const nodes = treeData.descendants();
    const links = treeData.links();

    nodes.forEach(d=>{
      const side = d.data._side !== undefined ?
                   d.data._side :
                   (d.parent ? d.parent.data._side || 1 : 1);

      d.screenX = d.x;
      d.screenY = d.depth * DEPTH_SPACING * side;
    });

    // --- NODES ---
    const node = g.selectAll("g.node").data(nodes, d=>d.data.ID);

    const enter = node.enter().append("g")
      .attr("class","node")
      .attr("transform",`translate(${source.y0},${source.x0})`)
      .style("cursor","pointer")
      .on("click",(e,d)=>{
        if(d.data.PhotoURL) window.open(d.data.PhotoURL,"_blank");
      })
      .on("dblclick",(e,d)=>{
        e.stopPropagation();
        if(d.children){ d._children=d.children; d.children=null; }
        else{ d.children=d._children; d._children=null; }
        update(d);
      })
      .on("mouseover",(e,d)=>{
        if(d.data.Details){
          tooltip.style("display","block").html(d.data.Details);
        }
      })
      .on("mousemove",(e)=>{
        tooltip.style("left",(e.pageX+12)+"px")
               .style("top",(e.pageY+12)+"px");
      })
      .on("mouseout",()=>tooltip.style("display","none"));

    enter.append("text")
      .attr("dy","0.35em")
      .attr("text-anchor","middle")
      .text(d=>d.data.Name);

    enter.each(function(d){
      const sel = d3.select(this);
      const t = sel.select("text").node();
      const bb = t.getBBox();

      const padX=14,padY=8;
      const w = bb.width + padX*2;
      const h = bb.height + padY*2;
      const depthIndex = Math.min(d.depth, fills.length-1);

      sel.insert("rect","text")
        .attr("x",-w/2).attr("y",-h/2)
        .attr("width",w).attr("height",h)
        .style("fill", d.depth===0 ? fills[0] : fills[depthIndex])
        .style("stroke", strokes[depthIndex]);

      if(d.depth===0){
        sel.select("text").style("fill","white").style("font-weight","700");
      }

      const side = d.data._side || (d.parent ? d.parent.data._side || 1 : 1);
      sel.append("circle")
        .attr("class","end-dot")
        .attr("r",5)
        .attr("cx", side>=0 ? w/2+10 : -(w/2+10))
        .attr("cy", 0)
        .style("opacity",(!d.children && !d._children)?1:0);
    });

    const merged = enter.merge(node);

    merged.transition().duration(450)
      .attr("transform",d=>`translate(${d.screenY},${d.screenX})`);

    node.exit().transition().duration(300).style("opacity",0).remove();


    // --- LINKS ---
    const link = g.selectAll("path.link").data(links, d=>d.target.data.ID);

    link.enter()
      .insert("path","g")
      .attr("class","link")
      .attr("d",_=>mindCurve(source,source))
      .merge(link)
      .transition().duration(450)
      .attr("d",d=>mindCurve(d.source,d.target));

    link.exit().transition().duration(300).style("opacity",0).remove();


    nodes.forEach(d=>{ d.x0=d.screenX; d.y0=d.screenY; });
  }


  // mind-map style S-curve
  function mindCurve(s,d){
    const sx=s.screenY, sy=s.screenX;
    const tx=d.screenY, ty=d.screenX;
    const dx=(tx-sx)*0.55;

    return `
      M ${sx},${sy}
      C ${sx+dx},${sy},
        ${tx-dx},${ty},
        ${tx},${ty}
    `;
  }


  // manual fit-to-content (only runs on load or when clicking button)
  function fitToContent(){
    const box = g.node().getBBox();
    const margin = 40;

    const fullW = svg.node().clientWidth;
    const fullH = svg.node().clientHeight;

    const scale = Math.min(
      (fullW - margin)/box.width,
      (fullH - margin)/box.height
    );

    const tx = (fullW - box.width*scale)/2 - box.x*scale;
    const ty = (fullH - box.height*scale)/2 - box.y*scale;

    svg.transition()
      .duration(600)
      .call(
        zoom.transform,
        d3.zoomIdentity.translate(tx,ty).scale(scale)
      );
  }

});
</script>

</body>
</html>

