<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Open Access & Open Science — Interactive Tree</title>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
  :root{
    --bg:#f7f9fc;
    --header-bg:#1f3a65;
    --header-fg:#ffffff;
    --node-fill:#eef4ff;
    --node-stroke:#1f3a65;
    --link-stroke:#8aa2c1;
    --font:"Segoe UI",Roboto,Arial,sans-serif;
  }
  html,body{
    margin:0;
    height:100%;
    font-family:var(--font);
    background:var(--bg);
  }
  header{
    background:var(--header-bg);
    color:var(--header-fg);
    padding:12px 0;
    text-align:center;
    font-size:20px;
    font-weight:600;
    position:relative;
    letter-spacing:0.3px;
    box-shadow:0 2px 4px rgba(0,0,0,0.25);
  }
  header .controls{
    position:absolute;
    left:12px;
    top:50%;
    transform:translateY(-50%);
    display:flex;
    gap:6px;
  }
  header button{
    background:white;
    color:var(--header-bg);
    border:1px solid var(--header-bg);
    padding:4px 10px;
    border-radius:6px;
    font-size:12px;
    cursor:pointer;
  }
  header button:hover{
    background:#e8efff;
  }

  #canvas{
    position:relative;
    height:calc(100vh - 50px);
    overflow:hidden;
  }
  #searchBox{
    position:absolute;
    top:12px;
    left:50%;
    transform:translateX(-50%);
    width:300px;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #cfd8e3;
    background:white;
    font-size:14px;
    z-index:20;
    box-shadow:0 1px 4px rgba(0,0,0,0.12);
  }
  #credits{
    position:absolute;
    right:16px;
    top:12px;
    background:white;
    max-width:260px;
    padding:10px 12px;
    border-radius:8px;
    font-size:12px;
    line-height:1.5;
    box-shadow:0 2px 8px rgba(0,0,0,0.15);
    z-index:20;
  }
  #tooltip{
    position:absolute;
    background:black;
    color:white;
    padding:6px 8px;
    border-radius:6px;
    font-size:12px;
    display:none;
    pointer-events:none;
    z-index:40;
  }

  svg.main{
    width:100%;
    height:100%;
    cursor:grab;
  }
  svg.minimap{
    position:absolute;
    right:16px;
    bottom:16px;
    width:240px;
    height:160px;
    border:1px solid #cfd8e3;
    background:white;
    box-shadow:0 2px 6px rgba(0,0,0,0.12);
    z-index:10;
  }

  .node rect{
    rx:10; ry:10;
    fill:var(--node-fill);
    stroke:var(--node-stroke);
    stroke-width:2px;
    filter:drop-shadow(0 1px 2px rgba(0,0,0,0.15));
  }
  .node text{
    font-size:14px;
    fill:#0f1c2e;
    pointer-events:none;
  }
  .node.linked text{
    fill:#1f3a65;
    text-decoration:underline;
  }
  .highlight rect{
    stroke:#ffeb3b !important;
    stroke-width:4px !important;
  }

  .link{
    fill:none;
    stroke:var(--link-stroke);
    stroke-width:2px;
    opacity:0.9;
  }
  .end-dot{
    fill:#c62828;
    stroke:#8e0000;
    stroke-width:1.4px;
  }
</style>
</head>

<body>
<header>
  <div class="controls">
    <button id="btnExpand">Expand All</button>
    <button id="btnCollapse">Collapse All</button>
    <button id="btnFit">Fit</button>
    <button id="btnExportSVG">SVG</button>
    <button id="btnExportPNG">PNG</button>
  </div>
  Open Access &amp; Open Science — Interactive Tree
</header>

<div id="canvas">
  <input id="searchBox" placeholder="Search..." />

  <div id="credits">
    <b>Credits</b>
    Dr. Tamal Kumar Guha<br/>
    Librarian, IIT Guwahati<br/><br/>
    Presented on 22 Nov 2025 at NEHU DLISc<br/>
    <i>Workshop:</i> Research Support Services
  </div>

  <svg class="main">
    <g id="tree"></g>
  </svg>

  <svg class="minimap">
    <g id="miniLinks"></g>
    <g id="miniNodes"></g>
  </svg>
</div>

<script>
const CSV_URL = "https://raw.githubusercontent.com/tkguha/oa/main/oaos.csv";

const svg = d3.select("svg.main");
const g = d3.select("#tree");
const miniSvg = d3.select("svg.minimap");
const miniLinks = d3.select("#miniLinks");
const miniNodes = d3.select("#miniNodes");

let root;

const zoom = d3.zoom()
  .scaleExtent([0.3, 2.2])
  .on("zoom", (event) => g.attr("transform", event.transform));
svg.call(zoom);

function width(){ return svg.node().clientWidth; }
function height(){ return svg.node().clientHeight; }

const treeLayout = d3.tree()
  .nodeSize([55, 240]);   // deep-tree optimized

d3.csv(CSV_URL).then(raw => {
  const rows = raw.map(r => ({
    id: (r.node_id || "").trim(),
    parentId: (r.parent_id || "").trim(),
    label: (r.topic || "").trim(),
    link: (r.links || "").trim()
  })).filter(r => r.id);

  const map = new Map();
  rows.forEach(r => map.set(r.id, {...r, children: []}));

  let rootData = null;
  map.forEach(n => {
    if (!n.parentId) rootData = n;
    else if (map.has(n.parentId)) map.get(n.parentId).children.push(n);
  });

  root = d3.hierarchy(rootData, d => d.children.length ? d.children : null);
  root.x0 = 0; root.y0 = 0;

  collapseAll(root);
  update(root);
  setTimeout(() => fitToScreen(), 700);

  document.getElementById("btnExpand").onclick = () => { expandAll(root); update(root); fitToScreen(); };
  document.getElementById("btnCollapse").onclick = () => { collapseAll(root); update(root); fitToScreen(); };
  document.getElementById("btnFit").onclick = () => fitToScreen();
  document.getElementById("btnExportSVG").onclick = exportSVG;
  document.getElementById("btnExportPNG").onclick = exportPNG;

  document.getElementById("searchBox").addEventListener("input", handleSearch);
});

function collapseAll(d){
  if (d.children) {
    d._children = d.children;
    d._children.forEach(collapseAll);
    d.children = null;
  }
}
function expandAll(d){
  if (d._children) {
    d.children = d._children;
    d._children = null;
  }
  d.children && d.children.forEach(expandAll);
}

function update(source){
  treeLayout(root);
  const nodes = root.descendants();
  const links = root.links();

  nodes.forEach(d => d.y = d.depth * 220);

  const nodeSel = g.selectAll("g.node")
    .data(nodes, d => d.data.id);

  const nodeEnter = nodeSel.enter()
    .append("g")
    .attr("class","node")
    .attr("transform", `translate(${source.y0},${source.x0})`)
    .style("cursor","pointer")
    .on("click", (event,d) => {
      event.stopPropagation();
      if (d.children) { d._children = d.children; d.children = null; }
      else { d.children = d._children; d._children = null; }
      update(d);
      centerOn(d);
    })
    .on("dblclick",(e,d)=>{ if(d.data.link) window.open(d.data.link,"_blank"); });

  nodeEnter.append("text")
    .attr("text-anchor","middle")
    .text(d => d.data.label || d.data.id);

  nodeEnter.each(function(d){
    const t = d3.select(this).select("text").node().getBBox();
    const padX = 14, padY = 7;
    const w = t.width + padX*2;
    const h = t.height + padY*2;

    d3.select(this)
      .insert("rect","text")
      .attr("x", -w/2)
      .attr("y", -h/2)
      .attr("width", w)
      .attr("height", h);

    d3.select(this).select("text")
      .attr("y", t.height/4);
  });

  const nodeMerge = nodeEnter.merge(nodeSel);

  nodeMerge.transition().duration(350)
    .attr("transform", d => `translate(${d.y},${d.x})`);

  nodeMerge.each(function(d){
    const g = d3.select(this);
    g.select("circle.end-dot").remove();
    if(!d.children && !d._children){
      const r = g.select("rect").node().getBBox();
      g.append("circle")
        .attr("class","end-dot")
        .attr("r",5)
        .attr("cx", r.x + r.width/2 + 12)
        .attr("cy", 0);
    }
  });

  nodeSel.exit()
    .transition().duration(250)
    .style("opacity",0)
    .remove();

  const linkSel = g.selectAll("path.link")
    .data(links, d => d.target.data.id);

  linkSel.enter()
    .insert("path","g")
    .attr("class","link")
    .attr("d", () => diagonal(source, source))
    .merge(linkSel)
    .transition().duration(350)
    .attr("d", d => diagonal(d.source, d.target));

  linkSel.exit().remove();

  nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });

  drawMinimap(nodes, links);
}

function diagonal(s,d){
  return `M${s.y},${s.x}
          C${(s.y+d.y)/2},${s.x}
           ${(s.y+d.y)/2},${d.x}
           ${d.y},${d.x}`;
}

function centerOn(d){
  const w = width(), h = height();
  const k = d3.zoomTransform(svg.node()).k;
  const tx = w/2 - d.y*k;
  const ty = h/2 - d.x*k;
  svg.transition().duration(400)
    .call(zoom.transform, d3.zoomIdentity.translate(tx,ty).scale(k));
}

function fitToScreen(){
  const box = g.node().getBBox();
  const w = width(), h = height();
  const margin = 60;
  const scale = Math.min(
    (w-margin)/box.width,
    (h-margin)/box.height
  );
  const s = Math.max(0.3, Math.min(scale,1.6));
  const tx = (w - box.width*s)/2 - box.x*s;
  const ty = (h - box.height*s)/2 - box.y*s;
  svg.transition().duration(600)
    .call(zoom.transform, d3.zoomIdentity.translate(tx,ty).scale(s));
}

function drawMinimap(nodes, links){
  const box = g.node().getBBox();
  const mw = miniSvg.node().clientWidth, mh = miniSvg.node().clientHeight;
  const scale = Math.min(mw/box.width, mh/box.height)*0.8;
  const tx = (mw - box.width*scale)/2 - box.x*scale;
  const ty = (mh - box.height*scale)/2 - box.y*scale;

  const transform = d => [d.y*scale + tx, d.x*scale + ty];

  const mLinks = miniLinks.selectAll("path").data(links);
  mLinks.enter().append("path").merge(mLinks)
    .attr("d", d => {
      const s = transform(d.source);
      const t = transform(d.target);
      return `M${s[0]},${s[1]} L${t[0]},${t[1]}`;
    })
    .attr("stroke","#b0bec5")
    .attr("stroke-width",1);
  mLinks.exit().remove();

  const mNodes = miniNodes.selectAll("circle").data(nodes);
  mNodes.enter().append("circle").merge(mNodes)
    .attr("r",2.2)
    .attr("cx", d => transform(d)[0])
    .attr("cy", d => transform(d)[1])
    .attr("fill","#37474f");
  mNodes.exit().remove();
}

function handleSearch(){
  const q = this.value.trim().toLowerCase();
  const nodes = g.selectAll("g.node");
  nodes.classed("highlight",false);
  if(!q) return;
  const matches = nodes.filter(d => d.data.label.toLowerCase().includes(q));
  matches.classed("highlight",true);
  const first = matches.datum();
  first && centerOn(first);
}

function exportSVG(){
  const outer = document.createElementNS("http://www.w3.org/2000/svg","svg");
  const clone = svg.node().cloneNode(true);
  outer.setAttribute("xmlns","http://www.w3.org/2000/svg");
  outer.setAttribute("width",width());
  outer.setAttribute("height",height());
  outer.appendChild(clone);
  const data = new XMLSerializer().serializeToString(outer);
  const blob = new Blob([data],{type:"image/svg+xml"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="oaos_tree.svg"; a.click();
  URL.revokeObjectURL(url);
}

function exportPNG(){
  const outer = document.createElementNS("http://www.w3.org/2000/svg","svg");
  const clone = svg.node().cloneNode(true);
  outer.setAttribute("xmlns","http://www.w3.org/2000/svg");
  outer.setAttribute("width",width());
  outer.setAttribute("height",height());
  outer.appendChild(clone);
  const data = new XMLSerializer().serializeToString(outer);
  const svgBlob = new Blob([data],{type:"image/svg+xml"});
  const url = URL.createObjectURL(svgBlob);
  const img = new Image();
  img.onload = ()=>{
    const canvas = document.createElement("canvas");
    canvas.width=width(); canvas.height=height();
    const ctx = canvas.getContext("2d");
    ctx.fillStyle="white"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);
    canvas.toBlob(b=>{
      const url2=URL.createObjectURL(b);
      const a=document.createElement("a");
      a.href=url2; a.download="oaos_tree.png"; a.click();
      URL.revokeObjectURL(url2);
    });
  };
  img.src=url;
}
</script>
</body>
</html>
